pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
function _init()

	_mx=0
	_my=0

	_hero=init_hero()
	enemies={}
	flocks={}

 for _=1,10 do
	 add_enemy(rnd()*128,rnd()*128)
	end
end

function _update()

	_dbg={}

	local b=btn()
	update_hero(b)
	foreach(enemies,update_enemy)
--	debug(collide(_hero,enemies[1],0.5,0.5))
end

function _draw()

	local hx=64
	local hy=64
	
	_mx=hx-_hero.x
	_my=hy-_hero.y
 
	if (_mx>0) then
		hx-=_mx
		if (hx<0) then 
			hx=0
			_hero.x=0
		end
		_mx=0
	end

	if (_my>0) then
		hy-=_my
		if (hy<0) then 
			hy=0
			_hero.y=0
		end
		_my=0
	end

	if (_mx<-896) then
		hx+=(_hero.x-(hx+896))
		if (hx>120) then
			hx=120
			_hero.x=1016
		end
		_mx=-896
	end

	if (_my<-128) then
		hy+=(_hero.y-(hy+128))
		if (hy>120) then
			hy=120
			_hero.y=248
		end
		_my=-128
	end

	palt(0,false)
	map(0,0,_mx,_my)
	palt(0,true)
	
	draw_hero(hx,hy)
	
	foreach(enemies,draw_enemy)
	
	local dbg_y=0

	for str in all(_dbg) do
		print(str,0,dbg_y,7)
		dbg_y+=8
	end
	
end

-->8
-- utilities

function setani(ent,ani)
	if (ani != ent.ani) then
		ent.ani=ani
		ent.ani_idx=1 
		ent.spr=ani[1][1]
		ent.wait=ani[1][2]
	end
end

function animate(ent)
 
	if (ent.wait>0) then
		ent.wait-=1
	else
		ent.ani_idx+=1

		if (ent.ani_idx>#ent.ani) ent.ani_idx=1

		ent.spr=ent.ani[ent.ani_idx][1]
		ent.wait=ent.ani[ent.ani_idx][2]
	end
 
end

function collide(e1,e2,i1,i2)
	
	if (not i1) i1=0
	if (not i2) i2=0
	
	local e1l=e1.x+i1
	local e1r=e1.x+7-i1
	local e1t=e1.y+i1
	local e1b=e1.y+7-i1
	local e2l=e2.x+i2
	local e2r=e2.x+7-i2
	local e2t=e2.y+i2
	local e2b=e2.y+7-i2
	
	return not ((e2l>e1r)
	 or         (e2r<e1l)
	 or         (e2t>e1b)
	 or         (e2b<e1t))
end

function debug(str)
	add(_dbg,str)
end

-->8
-- hero

function init_hero()
	local hero={}
	hero.max_hp=48
	hero.hp=48
	hero.x=32
	hero.y=32
	hero.flip=false
	hero.moving={{2,3},{3,3}}
	hero.idle={{2,90},{1,4}}
	setani(hero,hero.idle)
	return hero
end

function update_hero(b)

	local nx=_hero.x
	local ny=_hero.y
	local tx=0
	local ty=0

	if (band(b,1)==1) then
	 nx-=1.5
		_hero.flip=true
	end
	
	if (band(b,2)==2) then
		nx+=1.5
		_hero.flip=false
	end

	if (band(b,4)==4) then
		ny-=1.5
	end
	
	if (band(b,8)==8) then
		ny+=1.5
	end

	tl=((nx+1)/8)
	tr=((nx+6)/8)
	tt=((ny+4)/8)
	tb=((ny+6)/8)

	local tv=fget(mget(tl,tt))
	|        fget(mget(tr,tt))
	|        fget(mget(tl,tb))
	|        fget(mget(tr,tb))
	
	if (tv&1==0) then
		_hero.x=nx
		_hero.y=ny
	end

	-- collision check?
	
	

	if (b&0xf>0) then
		setani(_hero,_hero.moving)
	else
		setani(_hero,_hero.idle)
	end

	animate(_hero)

end

function draw_hero(x,y)
	
	spr(_hero.spr,x,y,1,1,_hero.flip)
	line(x-2,y+9,x+10,y+9,7)
	pset(x-2,y+10,6)
	pset(x+10,y+10,6)
	line(x-1,y+10,x+9,y+10,0)

	line(x-1,y+10,
		x+_hero.hp/_hero.max_hp*10-1,y+10,8)

	line(x-2,y+11,x+10,y+11,5)

end
-->8
-- enemies

function add_enemy(x,y)
	local en={}
	en.hp=2
	en.x=x
	en.y=y
	en.flip=false
	en.spd=0.5
	en.moving={{64,3},{65,3}}
	en.target=_hero
	setani(en,en.moving)	
	add(enemies,en)
end

function update_enemy(en)
	
	local ang=atan2((en.target.y)-en.y,(en.target.x)-en.x)
	local dx=sin(ang)*en.spd

	en.flip=(dx<0)
	en.x+=dx
	en.y+=cos(ang)*en.spd 

	animate(en)
	
	local odx=0
	local ody=0
	for o in all(_enemies) do
	 odx=o.x-en.x
	 ody=o.y-en.y
	end
end

function draw_enemy(en)
	spr(en.spr,_mx+en.x,_my+en.y,1,1,en.flip)
end

__gfx__
0000000033bb300033bb300003bb3040000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000
0000000003bbb34003bbb34033bbb304000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000
0070070003ffff0403f1f10403f1f104000000000000000000000000777777770000000000000000000000000000000000000000000000000000000000000000
0007700004ffff0404ffff0404ffff3f000000000000000000000000688888860000000000000000000000000000000000000000000000000000000000000000
0007700033bbb33f33bbb33f03bbb334000000000000000000000000555555550000000000000000000000000000000000000000000000000000000000000000
00700700f5446504f54465040f446504000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000
00000000033333040333330403333340000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000
00000000050005400500054050005000000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444444444444444044440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444444444444440404440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444444544444404440440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555559a9a554444444444444444044440440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5555555555a9a9554444444444444554404404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444444444444404044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444445544444040444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555554444444444444444044044440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666665559a5550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555a95550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666665559a5550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555a95550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66777666555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6766677690a990a50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
766666560a990a950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65766665595559550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
76666565595559550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65656656959595950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66555566959595950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00002e200000e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005666650cd666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02676878c76768780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0266d6d6c766d6d60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005766600cd766600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0076d6500076d6500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00655600006556000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8e8888e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88e88e88000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
888ee888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
888ee888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88e88e88000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8e8888e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1414141414141414303131313014141414141414141414141414141414141414141414141414141414141430313131301414141414141414141414141414141414143031313130141414141414141414141414141414141414141414141414141414141414141414141414303131313014141414141414141414141414141414
1414141412121212201021102012121212141414141414141414141414141414141414141414121212121220102110201214141414141414141212121212121212122010211020121212141414141414141414141414141414141414121212121214141414141212121212201021102014141412141414141412141414141414
1414141212121212201021102012121312121212141414121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212141414141414121212121212121212121212121212121212121212121212201021102012141212121212121212121214141414
1414121212121212201021102012121212121212121412121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121214141412121212121212121212121212121212121212121212121212201021102012121212121212121212121212141414
1414121213121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212141212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121213201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1412121212131212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
3020202020202020201111112020202020202020202020202020202020202020202020202020202020202020111111202020202020202020202020202020202020202011111120202020202020202020202020202020202020202020202020202020202020202020202020201111112020202020202020202020202020202030
3110101010101010211010102110101010101010101010101010101010101010101010101010101010101021101010211010101010101010101010101010101010102110101021101010101010101010101010101010101010101010101010101010101010101010101010211010102110101010101010101010101010101031
3111111111111111211010102111111111111111111111111111111111111111111111111111111111111121101010211111111111111111111111111111111111112110101021111111111111111111111111111111111111111111111111111111111111111111111111211010102111111111111111111111111111111131
3110101010101010211010102110101010101010101010101010101010101010101010101010101010101021101010211010101010101010101010101010101010102110101021101010101010101010101010101010101010101010101010101010101010101010101010211010102110101010101010101010101010101031
3020202020202020201111112020202020202020202020202020202020202020202020202020202020202020111111202020202020202020202020202020202020202011111120202020202020202020202020202020202020202020202020202020202020202020202020201111112020202020202020202020202020202030
1414121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1414121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212141414
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121214141414
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212141414
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1412121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1414121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121212121212121212121212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1414121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212121412121212121212141212121212121212121212121212121212121212121212201021102012121212121212121212121212121214
1414121212121212201021102012121212121212121212121212121212121212121212121212121212121220102110201212121212121212121212121212121212122010211020121212141414121212121214141412121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1414141212121212201021102012121212121412121212121212121212121212121414121212121212121420102110201212121212121212121212121414121212122010211020121214141414121212121214141414121212121212121212121212121212121212121212201021102012121212121212121212121212121414
1414141412121212201021102012121212141414121212121212121212121212141414141212121212141420102110201414121212121212121214141414121214122010211020121414141414141212121414141414121212121212121212121212121212121212121414201021102012121212121212121212121212141414
1414141414141212201021102014141212141414141212141412121212121214141414141414121414141420102110201414141212121414141214141414121414142010211020141414141414141414141414141414141414141414141412121212121212121414141414201021102014121212121214141414121414141414
1414141414141414303131313014141414141414141414141414141414141414141414141414141414141430313131301414141414141414141414141414141414143031313130141414141414141414141414141414141414141414141414141414141414141414141414303131313014141414141414141414141414141414
